{
	"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"targetStorageAccountName": {
			"type": "string",
			"metadata": {
				"description": "the name of the storage account that will be monitored by the function app"
			}
		},
    "functionAppName": {
      "type": "string",
      "metadata": {
        "description": "name your new function that will be created"
      }
    },
		"PhotoDNASubscriptionEndpoint": {
			"type": "string",
			"metadata": {
				"description": "Your unique PhotoDNA endpoint addess this can be found here: "
			}
		},
    "PhotoDNASubscriptionKey": {
      "type": "string",
      "metadata": {
        "description": "Your unique PhotoDNA subscription key, this can be found here: "
      }
    },
    "logVerbose":{
      "type": "bool",
      "metadata": {
        "description": "With this set to True, the function will Log each step of its execution in the Logs available in the Azure portal, with it set to false the function will not Log its execution except on Begin and End Execution and on Errors"
      }
    },
		"smtpHostAddress": {
			"type": "string",
			"metadata": {
				"description": "The Host address used for your Simple Mail account"
			}
		},
		"smtpPassword": {
			"type": "string",
			"metadata": {
				"description": "The password created for your specific user for Simple Mail"
			}
		},
		"smtpUserName": {
			"type": "string",
			"metadata": {
				"description": "The user name used to create you Simple Mail account"
			}
		},
		"notificationSenderEmail": {
			"type": "string",
			"metadata": {
				"description": "The email account that will be used to send the notification emails."
			}
		},
		"notificationReceiverEmail": {
			"type": "string",
			"metadata": {
				"description": "The email that will receive notificaitons when PhotoDNA happens to find a match on images uploaded to your storage"
			}
		},
		"callbackEndpoint": {
			"type": "string",
      "defaultValue": "",
			"metadata": {
				"description": "(optional) when PhotoDNA returns a match or errors occure, the results will be posted to this address"
			}
		}
	},
	"variables": {
		"functionAppName": "[parameters('functionAppName')]",
		"storageAccountName": "[parameters('targetStorageAccountName')]",
		"senderEmail": "[parameters('notificationSenderEmail')]",
		"receiverEmail": "[parameters('notificationReceiverEmail')]",
		"subscriptionEndpoint": "[parameters('PhotoDNASubscriptionEndpoint')]",
		"subscriptionKey": "[parameters('PhotoDNASubscriptionKey')]",
    "callbackEndpoint": "[parameters('callbackEndpoint')]",
    "smtpHostAddress": "[parameters('smtpHostAddress')]",
    "smtpPassword": "[parameters('smtpPassword')]",
    "smtpUserName": "[parameters('smtpUserName')]",
    "imageQueueName": "pdnamonitoringimagequeue",
    "defaultSASKeyName": "RootManageSharedAccessKey",
    "sbVersion": "2017-04-01",
    "logVerbose": "[parameters('logVerbose')]"
	},
  "resources": [
    {
      "apiVersion": "2014-04-01",
      "name": "[parameters('functionAppName')]",
      "type": "Microsoft.Insights/components",
      "location": "East US",
      "tags": {
          "[concat('hidden-link:', resourceGroup().id, '/providers/Microsoft.Web/sites/', parameters('functionAppName'))]": "Resource",
          "displayName": "AppInsightsComponent"
      },
      "properties": {
          "applicationId": "[parameters('functionAppName')]"
      }
    },
    {
      "apiVersion": "2016-08-01",
      "kind": "functionapp",
      "name": "[parameters('functionAppName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "config": {
          "bindings": [
            {
              "authLevel": "anonymous",
              "name": "req",
              "type": "blobTrigger",
              "direction": "in",
              "path": "YourBlobNameHere/{name}.{ext}",
              "connection": "AzureWebJobsStorage"
            }
          ]
        },
        "appSettings": [
          {
            "name": "AzureWebJobsDashboard",
            "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2015-05-01-preview').key1)]"
          },
          {
            "name": "AzureWebJobsStorage",
            "value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2015-05-01-preview').key1)]"
          },
          {
            "name": "storageAccountName",
            "value": "variables('storageAccountName')"

          },
          {
            "name": "functionAppName",
            "value": "variables('functionAppName')"
          },
          {
            "name": "senderEmail",
            "value": "variables('senderEmail')"
          },
          {
            "name": "receiverEmail",
            "value": "variables('receiverEmail')"
          },
          {
            "name": "subscriptionEndpoint",
            "value": "variables('subscriptionEndpoint')"
          },
          {
            "name": "subscriptionKey",
            "value": "variables('subscriptionKey')"
          },
          {
            "name": "callbackEndpoint",
            "value": "variables('callbackEndpoint')"
          },
          {
            "name": "smtpHostAddress",
            "value": "variables('smtpHostAddress')"
          },
          {
            "name": "smtpPassword",
            "value": "variables('smtpPassword')"
          },
          {
            "name": "smtpUserName",
            "value": "variables('smtpUserName')"
          },
          {
            "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
            "value": "[reference(concat('microsoft.insights/components/', parameters('functionAppName'))).InstrumentationKey]"
          }
        ]
      },
      "resources": [
        {
          "name": "appsettings",
          "type": "config",
          "apiVersion": "2016-08-01",
          "dependsOn": [
            "[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
          ],
          "properties": {
            "AzureWebJobsStorage": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2015-05-01-preview').key1)]",
            "AzureWebJobsDashboard": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2015-05-01-preview').key1)]",
            "functionAppName": "[parameters('functionAppName')]",
            "storageAccountName": "[parameters('targetStorageAccountName')]",
            "senderEmail": "[parameters('notificationSenderEmail')]",
            "receiverEmail": "[parameters('notificationReceiverEmail')]",
            "subscriptionEndpoint": "[parameters('PhotoDNASubscriptionEndpoint')]",
            "subscriptionKey": "[parameters('PhotoDNASubscriptionKey')]",
            "callbackEndpoint": "[parameters('callbackEndpoint')]",
            "smtpHostAddress": "[parameters('smtpHostAddress')]",
            "smtpPassword": "[parameters('smtpPassword')]",
            "smtpUserName": "[parameters('smtpUserName')]",
            "imageQueueName": "pdnamonitoringimagequeue",
            "logVerbose": "[parameters('logVerbose')]",
            "APPINSIGHTS_INSTRUMENTATIONKEY": "[reference(concat('microsoft.insights/components/', parameters('functionAppName'))).InstrumentationKey]"
          }
        }
      ],
      "type": "Microsoft.Web/sites"
    }

  ],
		"outputs":
		{}
}
