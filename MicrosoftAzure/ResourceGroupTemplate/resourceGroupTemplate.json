{
	"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"callbackEndpoint": {
			"type": "string",
			"metadata": {
				"description": "(optional) when PhotoDNA returns a match or errors occure, the results will be posted to this address"
			}
		},
		"functionAppName": {
			"type": "string",
			"metadata": {
				"description": "name of the new function that will be created"
			}
		},
		"receiverEmail": {
			"type": "string",
			"metadata": {
				"description": "The email that will receive notificaitons when PhotoDNA happens to find a match on images uploaded to your storage"
			}
		},
		"senderEmail": {
			"type": "string",
			"metadata": {
				"description": "The email account that will be used to send the notification emails."
			}
		},
		"storageAccountName": {
			"type": "string",
			"metadata": {
				"description": "the name of the storage account that will be monitored by the function app"
			}
		},
		"targetStorageBlobName": {
			"type": "string",
			"metadata": {
				"description": "the name of the storage blob that will be monitored by the function app"
			}
		},
		"subscriptionEndpoint": {
			"type": "string",
			"metadata": {
				"description": "Your unique PhotoDNA endpoint addess this can be found here: "
			}
		},
		"subscriptionKey": {
			"type": "string",
			"metadata": {
				"description": "Your unique PhotoDNA subscription key, this can be found here: "
			}
		}
	},
	"variables": {
		"pdnaStorageAccountName": "[concat('pdnaStorageAccount', uniqueString(resourceGroup().id))]",
		"functionAppName": "[parameters('functionAppName')]",
		"targetStorageBlobName": "[parameters('targetStorageBlobName')]",
		"storageAccountName": "[parameters('storageAccountName')]",
		"senderEmail": "[parameters('senderEmail')]",
		"receiverEmail": "[parameters('receiverEmail')]",
		"subscriptionEndpoint": "[parameters('subscriptionEndpoint')]",
		"subscriptionKey": "[parameters('subscriptionKey')]",
		"callbackEndpoint": "[parameters('callbackEndpoint')]"
	},
	"resources": [
					{
						"apiVersion": "2016-08-01",
						"kind": "functionapp",
						"name": "[parameters('functionAppName')]",
						"location": "[resourceGroup().location]",
						"properties": {
							"config": {
								"bindings": [
									{
										"authLevel": "anonymous",
										"name": "req",
										"type": "blobTrigger",
										"direction": "in",
										"path": "[parameters('targetStorageBlobName')]/{name}",
										"connection": "AzureWebJobsStorage"
									}
								]
							},
							"appSettings": [
								{
									"name": "AzureWebJobsDashboard",
									"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2015-05-01-preview').key1)]"
								},
								{
									"name": "AzureWebJobsStorage",
									"value": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2015-05-01-preview').key1)]"
								},
								{
									"name": "senderEmail",
									"value": "variables('senderEmail')"
								},
								{
									"name": "receiverEmail",
									"value": "variables('receiverEmail')"
								},
								{
									"name": "subscriptionEndpoint",
									"value": "variables('subscriptionEndpoint')"
								},
								{
									"name": "subscriptionKey",
									"value": "variables('subscriptionKey')"
								},
								{
									"name": "callbackEndpoint",
									"value": "variables('callbackEndpoint')"
								}
							]
						},
						"resources": [
							{
								"name": "appsettings",
								"type": "config",
								"apiVersion": "2016-08-01",
								"dependsOn": [
									"[resourceId('Microsoft.Web/sites', parameters('functionAppName'))]"
								],
								"properties": {
									"AzureWebJobsStorage": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2015-05-01-preview').key1)]",
									"AzureWebJobsDashboard": "[concat('DefaultEndpointsProtocol=https;AccountName=', variables('storageAccountName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')),'2015-05-01-preview').key1)]"
								}
							}
						],
						"type": "Microsoft.Web/sites"
					}

	],
		"outputs":
		{}
}
